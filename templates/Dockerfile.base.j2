# =============================================================================
# Dockerfile.base.j2 - Base image template for Ascend Docker environments
# Generated by Ascend Docker Kit (ADK) v{{ adk_version }}
# =============================================================================
# Target: {{ target }}
# OS: {{ os_name }}
# Architecture: {{ arch }}
# Python: {{ python_version }}
# =============================================================================

ARG BASE_IMAGE={{ base_image }}

FROM ${BASE_IMAGE} AS base

# Image metadata
LABEL maintainer="ADK Team"
LABEL org.opencontainers.image.title="Ascend Docker Kit Base"
LABEL org.opencontainers.image.description="Base image for Huawei Ascend NPU environments"
LABEL adk.version="{{ adk_version }}"
LABEL adk.cann_version="{{ cann_version }}"
LABEL adk.target="{{ target }}"
LABEL adk.os="{{ os_name }}"
LABEL adk.arch="{{ arch }}"

# Prevent interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# =============================================================================
# Configure APT mirror for faster downloads (China)
# =============================================================================
{% if use_china_mirror %}
RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list 2>/dev/null || true && \
    sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list 2>/dev/null || true
{% endif %}

# =============================================================================
# Install system dependencies
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Basic utilities
    ca-certificates \
    curl \
    wget \
    git \
    vim \
    less \
    unzip \
    # Networking tools
    net-tools \
    iputils-ping \
    openssh-client \
    openssh-server \
{% if target == "train" %}
    # Build tools (training only)
    build-essential \
    gcc \
    g++ \
    make \
    cmake \
    pkg-config \
    autoconf \
    automake \
    libtool \
{% endif %}
    # Python {{ python_version }}
    python{{ python_version }} \
    python{{ python_version }}-dev \
    python{{ python_version }}-venv \
    python3-pip \
    # Libraries required by CANN
    libsqlite3-dev \
    zlib1g-dev \
    libssl-dev \
    libffi-dev \
    libbz2-dev \
    liblzma-dev \
    libreadline-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libsystemd-dev \
{% if target == "train" %}
    # Additional training dependencies
    libnuma-dev \
    pciutils \
    numactl \
    libhwloc-dev \
{% endif %}
    # Cleanup
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# =============================================================================
# Configure Python
# =============================================================================
# Set Python {{ python_version }} as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python{{ python_version }} 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python{{ python_version }} 1 && \
    update-alternatives --set python /usr/bin/python{{ python_version }} && \
    update-alternatives --set python3 /usr/bin/python{{ python_version }}

# Upgrade pip and install basic packages
RUN python -m pip install --no-cache-dir --upgrade \
    pip \
    setuptools \
    wheel

{% if use_china_mirror %}
# Configure pip mirror for faster downloads (China)
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn
{% endif %}

# =============================================================================
# Create necessary directories
# =============================================================================
RUN mkdir -p /usr/local/Ascend && \
    mkdir -p /var/log/npu && \
    mkdir -p /workspace

# =============================================================================
# Environment configuration
# =============================================================================
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Working directory
WORKDIR /workspace
