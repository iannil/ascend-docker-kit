# =============================================================================
# Dockerfile.cann.j2 - CANN installation template
# Generated by Ascend Docker Kit (ADK) v{{ adk_version }}
# =============================================================================
# CANN Version: {{ cann_version }}
# NPU Type: {{ npu_type }}
# Target: {{ target }}
# =============================================================================

# =============================================================================
# CANN Builder Stage
# =============================================================================
FROM base AS cann-builder

# Copy CANN installation packages
# Note: User must download these from https://www.hiascend.com/
COPY {{ cann_toolkit_filename }} /tmp/cann_toolkit.run
{% if cann_kernels_filename %}
COPY {{ cann_kernels_filename }} /tmp/cann_kernels.run
{% endif %}

# Copy installation script
COPY scripts/install_cann.sh /tmp/install_cann.sh

# Install CANN with cleanup in the same layer to reduce image size
RUN chmod +x /tmp/install_cann.sh && \
    /tmp/install_cann.sh /tmp/cann_toolkit.run \
{% if cann_kernels_filename %}
        /tmp/cann_kernels.run \
{% endif %}
        --cleanup && \
    rm -f /tmp/cann_toolkit.run /tmp/install_cann.sh \
{% if cann_kernels_filename %}
    && rm -f /tmp/cann_kernels.run \
{% endif %}
    && rm -rf /tmp/Ascend*

# =============================================================================
# CANN Environment Variables
# =============================================================================
ENV ASCEND_HOME=/usr/local/Ascend
ENV ASCEND_TOOLKIT_HOME=${ASCEND_HOME}/ascend-toolkit/latest

# Library paths
ENV LD_LIBRARY_PATH=${ASCEND_TOOLKIT_HOME}/lib64:${ASCEND_TOOLKIT_HOME}/lib64/plugin/opskernel:${ASCEND_TOOLKIT_HOME}/lib64/plugin/nnengine:${LD_LIBRARY_PATH}

# Binary paths
ENV PATH=${ASCEND_TOOLKIT_HOME}/bin:${ASCEND_TOOLKIT_HOME}/compiler/ccec_compiler/bin:${PATH}

# Python paths
ENV PYTHONPATH=${ASCEND_TOOLKIT_HOME}/python/site-packages:${ASCEND_TOOLKIT_HOME}/opp/built-in/op_impl/ai_core/tbe:${PYTHONPATH}

# CANN specific paths
ENV ASCEND_AICPU_PATH=${ASCEND_TOOLKIT_HOME}
ENV ASCEND_OPP_PATH=${ASCEND_TOOLKIT_HOME}/opp
ENV TOOLCHAIN_HOME=${ASCEND_TOOLKIT_HOME}/toolkit

{% if target == "train" %}
# HCCL configuration for distributed training
ENV HCCL_CONNECT_TIMEOUT=1800
ENV HCCL_EXEC_TIMEOUT=1800
ENV HCCL_WHITELIST_DISABLE=1
{% endif %}

# Verify CANN installation (basic check)
RUN echo "Verifying CANN installation..." && \
    ls -la ${ASCEND_TOOLKIT_HOME}/lib64/ | head -5 && \
    python -c "import sys; sys.path.insert(0, '${ASCEND_TOOLKIT_HOME}/python/site-packages'); print('CANN Python packages available')" || true

{% if target == "train" %}
# =============================================================================
# Training Stage - Full development environment
# =============================================================================
FROM cann-builder AS train

# Training stage inherits everything from cann-builder
# All development tools, compilers, and headers are preserved

# Additional metadata for training image
LABEL adk.stage="train"
LABEL adk.description="Full CANN development environment for training"

{% else %}
# =============================================================================
# Inference Stage - Minimal runtime environment
# =============================================================================
FROM base AS inference

# Copy only necessary runtime components from cann-builder
COPY --from=cann-builder /usr/local/Ascend /usr/local/Ascend
COPY --from=cann-builder /etc/profile.d/ascend.sh /etc/profile.d/ascend.sh

# Configure environment for inference runtime
ENV ASCEND_HOME=/usr/local/Ascend
ENV ASCEND_TOOLKIT_HOME=${ASCEND_HOME}/ascend-toolkit/latest
ENV LD_LIBRARY_PATH=${ASCEND_TOOLKIT_HOME}/lib64:${LD_LIBRARY_PATH}
ENV PATH=${ASCEND_TOOLKIT_HOME}/bin:${PATH}
ENV PYTHONPATH=${ASCEND_TOOLKIT_HOME}/python/site-packages:${PYTHONPATH}

# Additional metadata for inference image
LABEL adk.stage="inference"
LABEL adk.description="Minimal CANN runtime for inference"

{% endif %}
