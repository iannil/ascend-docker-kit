# =============================================================================
# Dockerfile.pytorch.j2 - PyTorch framework installation template
# Generated by Ascend Docker Kit (ADK) v{{ adk_version }}
# =============================================================================
# PyTorch Version: {{ pytorch_version }}
# torch_npu Version: {{ torch_npu_version }}
# Target: {{ target }}
# =============================================================================

{% if target == "train" %}
FROM train AS pytorch
{% else %}
FROM inference AS pytorch
{% endif %}

# Framework metadata
LABEL adk.framework="pytorch"
LABEL adk.pytorch_version="{{ pytorch_version }}"
{% if torch_npu_version %}
LABEL adk.torch_npu_version="{{ torch_npu_version }}"
{% endif %}

# =============================================================================
# Install PyTorch
# =============================================================================
# Install PyTorch CPU version from official PyPI
# NPU backend is provided by torch_npu package
RUN pip install --no-cache-dir \
    torch=={{ pytorch_version }} \
    torchvision \
    torchaudio \
    --index-url https://download.pytorch.org/whl/cpu

# =============================================================================
# Install torch_npu
# =============================================================================
{% if torch_npu_whl_url %}
# Install from pre-built wheel URL (recommended for version compatibility)
RUN pip install --no-cache-dir "{{ torch_npu_whl_url }}"
{% elif torch_npu_version %}
# Install from pip
RUN pip install --no-cache-dir torch-npu=={{ torch_npu_version }}
{% else %}
# torch_npu version not specified, attempting latest compatible version
RUN pip install --no-cache-dir torch-npu || echo "Warning: torch_npu installation failed, please install manually"
{% endif %}

# =============================================================================
# Install additional ML dependencies
# =============================================================================
RUN pip install --no-cache-dir \
    # Core scientific packages
    numpy \
    scipy \
    pandas \
    scikit-learn \
    # Utilities
    tqdm \
    pyyaml \
    requests \
    # Visualization and logging
    tensorboard \
    matplotlib \
{% if target == "train" %}
    # Training-specific packages
    transformers \
    datasets \
    accelerate \
    peft \
    bitsandbytes \
    sentencepiece \
    tokenizers \
{% endif %}
    # Cleanup pip cache in same layer
    && rm -rf /root/.cache/pip

# =============================================================================
# Copy utility scripts
# =============================================================================
COPY scripts/check_npu.sh /usr/local/bin/check_npu.sh
RUN chmod +x /usr/local/bin/check_npu.sh

# =============================================================================
# Verify installation
# =============================================================================
RUN echo "Verifying PyTorch installation..." && \
    python -c "import torch; print('PyTorch version:', torch.__version__)" && \
    python -c "import torch_npu; print('torch_npu version:', torch_npu.__version__)" && \
    echo "PyTorch and torch_npu installed successfully"

# =============================================================================
# Entrypoint configuration
# =============================================================================
# Create entrypoint script that sources CANN environment
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Source CANN environment' >> /entrypoint.sh && \
    echo 'if [ -f /etc/profile.d/ascend.sh ]; then' >> /entrypoint.sh && \
    echo '    source /etc/profile.d/ascend.sh' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Run NPU check if requested' >> /entrypoint.sh && \
    echo 'if [ "$CHECK_NPU" = "1" ]; then' >> /entrypoint.sh && \
    echo '    /usr/local/bin/check_npu.sh' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]

# =============================================================================
# Expose common ports
# =============================================================================
# TensorBoard
EXPOSE 6006
# Jupyter Notebook
EXPOSE 8888
{% if target == "train" %}
# Distributed training (torch.distributed)
EXPOSE 29500
EXPOSE 29501
{% endif %}

# =============================================================================
# Health check
# =============================================================================
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD python -c "import torch; import torch_npu; print('OK')" || exit 1

# =============================================================================
# Final working directory
# =============================================================================
WORKDIR /workspace
