# =============================================================================
# Dockerfile.mindspore.j2 - MindSpore framework installation template
# Generated by Ascend Docker Kit (ADK) v{{ adk_version }}
# =============================================================================
# MindSpore Version: {{ framework_version }}
# Target: {{ target }}
# =============================================================================

{% if target == "train" %}
FROM train AS mindspore
{% else %}
FROM inference AS mindspore
{% endif %}

# Framework metadata
LABEL adk.framework="mindspore"
LABEL adk.mindspore_version="{{ framework_version }}"

# =============================================================================
# Install MindSpore
# =============================================================================
{% if install_command %}
# Install using specified command
RUN {{ install_command }}
{% else %}
# Install MindSpore for Ascend NPU
RUN pip install --no-cache-dir mindspore=={{ framework_version }}
{% endif %}

# =============================================================================
# Install additional ML dependencies
# =============================================================================
RUN pip install --no-cache-dir \
    # Core scientific packages
    numpy \
    scipy \
    pandas \
    scikit-learn \
    # Utilities
    tqdm \
    pyyaml \
    requests \
    # Visualization
    matplotlib \
    pillow \
{% if target == "train" %}
    # Training-specific packages
    mindformers \
    mindnlp \
    mindcv \
{% endif %}
    # Cleanup pip cache in same layer
    && rm -rf /root/.cache/pip

# =============================================================================
# Copy utility scripts
# =============================================================================
COPY scripts/check_npu.sh /usr/local/bin/check_npu.sh
RUN chmod +x /usr/local/bin/check_npu.sh

# =============================================================================
# Verify installation
# =============================================================================
RUN echo "Verifying MindSpore installation..." && \
    python -c "import mindspore; print('MindSpore version:', mindspore.__version__)" && \
    python -c "from mindspore import context; print('MindSpore context available')" && \
    echo "MindSpore installed successfully"

# =============================================================================
# Entrypoint configuration
# =============================================================================
# Create entrypoint script that sources CANN environment
RUN echo '#!/bin/bash' > /entrypoint.sh && \
    echo 'set -e' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Source CANN environment' >> /entrypoint.sh && \
    echo 'if [ -f /etc/profile.d/ascend.sh ]; then' >> /entrypoint.sh && \
    echo '    source /etc/profile.d/ascend.sh' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Configure MindSpore for Ascend' >> /entrypoint.sh && \
    echo 'export DEVICE_ID=${DEVICE_ID:-0}' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo '# Run NPU check if requested' >> /entrypoint.sh && \
    echo 'if [ "$CHECK_NPU" = "1" ]; then' >> /entrypoint.sh && \
    echo '    /usr/local/bin/check_npu.sh' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo '' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["bash"]

# =============================================================================
# Expose common ports
# =============================================================================
# MindInsight (visualization tool)
EXPOSE 8080
# Jupyter Notebook
EXPOSE 8888
{% if target == "train" %}
# Distributed training
EXPOSE 8118
EXPOSE 8119
{% endif %}

# =============================================================================
# Health check
# =============================================================================
HEALTHCHECK --interval=60s --timeout=10s --start-period=10s --retries=3 \
    CMD python -c "import mindspore; print('OK')" || exit 1

# =============================================================================
# Final working directory
# =============================================================================
WORKDIR /workspace
