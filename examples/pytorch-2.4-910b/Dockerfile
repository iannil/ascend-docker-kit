# PyTorch 2.4 + CANN 8.0.0 for Atlas 910B
# Generated by Ascend Docker Kit (ADK)

ARG BASE_IMAGE=ubuntu:22.04
ARG PYTHON_VERSION=3.10

# ==============================================================================
# Stage 1: Base image with system dependencies
# ==============================================================================
FROM ${BASE_IMAGE} AS base

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    wget \
    git \
    vim \
    build-essential \
    cmake \
    ninja-build \
    libssl-dev \
    libffi-dev \
    libsqlite3-dev \
    libbz2-dev \
    libreadline-dev \
    zlib1g-dev \
    liblzma-dev \
    libncurses5-dev \
    libgdbm-dev \
    libnss3-dev \
    pciutils \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# Install Python
ARG PYTHON_VERSION
RUN apt-get update && apt-get install -y --no-install-recommends \
    python${PYTHON_VERSION} \
    python${PYTHON_VERSION}-dev \
    python${PYTHON_VERSION}-venv \
    python3-pip \
    && ln -sf /usr/bin/python${PYTHON_VERSION} /usr/bin/python3 \
    && ln -sf /usr/bin/python${PYTHON_VERSION} /usr/bin/python \
    && python -m pip install --upgrade pip setuptools wheel \
    && rm -rf /var/lib/apt/lists/*

# ==============================================================================
# Stage 2: Install CANN toolkit
# ==============================================================================
FROM base AS cann-builder

# CANN installation directory
ENV ASCEND_HOME=/usr/local/Ascend
ENV LD_LIBRARY_PATH=${ASCEND_HOME}/ascend-toolkit/latest/lib64:${LD_LIBRARY_PATH}
ENV PATH=${ASCEND_HOME}/ascend-toolkit/latest/bin:${PATH}

# Copy CANN packages (user must download these from Huawei official site)
# Expected files:
#   - Ascend-cann-toolkit_8.0.0_linux-x86_64.run
#   - Ascend-cann-kernels-910b_8.0.0_linux-x86_64.run
COPY packages/Ascend-cann-toolkit*.run /tmp/
COPY packages/Ascend-cann-kernels*.run /tmp/

# Install CANN toolkit
RUN chmod +x /tmp/*.run \
    && /tmp/Ascend-cann-toolkit*.run --install --quiet \
    && /tmp/Ascend-cann-kernels*.run --install --quiet \
    && rm -f /tmp/*.run

# ==============================================================================
# Stage 3: Install PyTorch and torch_npu
# ==============================================================================
FROM cann-builder AS pytorch

# Install PyTorch CPU version first
RUN pip install torch==2.4.0 --index-url https://download.pytorch.org/whl/cpu

# Install torch_npu
ARG TORCH_NPU_VERSION=2.4.0.post2
ARG ARCH=x86_64
RUN pip install torch_npu==${TORCH_NPU_VERSION}

# Install additional packages
RUN pip install numpy scipy pandas matplotlib jupyter

# ==============================================================================
# Stage 4: Final training image
# ==============================================================================
FROM pytorch AS train

# Set environment variables
ENV ASCEND_HOME=/usr/local/Ascend
ENV ASCEND_AICPU_PATH=${ASCEND_HOME}/ascend-toolkit/latest
ENV LD_LIBRARY_PATH=${ASCEND_HOME}/ascend-toolkit/latest/lib64:${ASCEND_HOME}/driver/lib64:${LD_LIBRARY_PATH}
ENV PATH=${ASCEND_HOME}/ascend-toolkit/latest/bin:${PATH}
ENV PYTHONPATH=${ASCEND_HOME}/ascend-toolkit/latest/python/site-packages:${PYTHONPATH}

# Source CANN environment
RUN echo "source ${ASCEND_HOME}/ascend-toolkit/set_env.sh" >> /etc/bash.bashrc

WORKDIR /workspace

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD python -c "import torch; import torch_npu; print(torch_npu.npu.is_available())" || exit 1

CMD ["/bin/bash"]
